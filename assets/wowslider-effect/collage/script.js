// ws_collage
// options.noCanvas
// options.maxQuality - [bool] if false, do not redraw the entire scene every frame.
// options.maxPreload - [int] maximum preloaded images
// options.transparentBack - [bool]
function ws_collage(g,q,H){function w(a,b,r){return parseFloat(r*(b-a)+a)}function x(a,b,r){var c=r*b.x,S=r*b.y,d=r*b.width;r*=b.height;U?(a.save(),a.translate(c+.5*d,S+.5*r),a.rotate(b.angle*Math.PI/180),a.scale(b.scale,b.scale),b.img&&a.drawImage(b.img,-.5*d,-.5*r,d,r),a.restore()):y("<img>").attr("src",b.img).css({position:"absolute",width:100*d/g.width+"%",height:100*r/g.height+"%",left:100*c/g.width+"%",top:100*S/g.height+"%"}).appendTo(a)}function ha(a,b,r,V,S,T){var P=n[a],R=n[b];U&&(a=y(q[b]),
a={width:a.width(),height:a.height(),marginTop:parseFloat(a.css("marginTop")),marginLeft:parseFloat(a.css("marginLeft"))},y(h).css(a));wowAnimate(function(a){var b=1-2*a;0>b&&(b*=-1,1<b&&(b=1));b=jQuery.easing.easeInOutQuad(1,b,0,1,1);a=jQuery.easing.easeInOutQuad(1,a,0,1,1);if(U){c.width=V;c.height=S;h.width=V;h.height=S;var q=w(g.width/R.width,g.width/P.width,a),e=w(.5,w(1/R.scale,1/P.scale,a),b),k=w(1/R.scale,1/P.scale,a),t=w(R.angle,P.angle,a),T=r*P.width,p=r*P.height,l=r*w(R.x,P.x,a),m=r*w(R.y,
P.y,a);aa&&A&&(c.ctx.drawImage(A,0,0,V,S),c.ctx.save(),c.ctx.translate(l+.5*T,m+.5*p),c.ctx.rotate(-t*Math.PI/180),c.ctx.scale(k,k),c.ctx.translate(-(l+.5*T),-(m+.5*p)),c.ctx.transform(k,0,0,k,-l*k,-m*k),c.ctx.drawImage(A,-V,-S,4*V,4*S),c.ctx.restore());c.ctx.transform(q,0,0,q,-l*q,-m*q);c.ctx.translate(l+.5*T,m+.5*p);c.ctx.rotate(-t*Math.PI/180);c.ctx.scale(e,e);c.ctx.translate(-(l+.5*T),-(m+.5*p));c.ctx.globalAlpha=w(.2,1,b);if(Y)for(d in n)x(c.ctx,n[d],r);else c.ctx.drawImage(B,0,0);c.ctx.globalAlpha=
1;c.ctx.globalAlpha=w(0,1,b);x(c.ctx,P,r);c.ctx.globalAlpha=w(1,0,1<2*a?1:2*a);x(c.ctx,R,r);c.ctx.globalAlpha=1;h.ctx.drawImage(c,0,0)}else b=w(2,V/(R.width*r),b),l=-r*w(R.x,P.x,a)*b,m=-r*w(R.y,P.y,a)*b,T=V*b,p=S*b,h.css({left:l,top:m,width:T,height:p});v.show()},0,1,g.duration,function(){T()})}function Q(a,b,r,c,d){if(!(a>b||!n[a]||n[a].img)){var g=new Image;g.onload=function(){n[a].img=g;r&&a!=d[0]&&a!=d[1]?(x(c,n[a],1),Q(a+1,b,!0,c,d)):Q(a+1,b,!1)};g.onerror=function(){r&&a!=d[0]&&a!=d[1]?(x(c,
n[a],1),Q(a+1,b,!0,c,d)):Q(a+1,b,!1)};g.src=q[a].src}}function ia(a,b,d){if(U){d.ctx.drawImage(a.get(0),0,0);var c;a:{c=d.ctx;var g=d.width,n=d.height;if(isNaN(b)||1>b)c=void 0;else{b|=0;var q;try{q=c.getImageData(0,0,g,n)}catch(w){console.log("error:unable to access image data: "+w);c=!1;break a}var u=q.data,h,v,e,k,t,y,p,l,m,M,N,O,C,D,E,I,J,K,x;h=b+b+1;var A=g-1,L=n-1,F=b+1,z=F*(F+1)/2,B=new da,f=B;for(e=1;e<h;e++)if(f=f.next=new da,e==F)var Q=f;f.next=B;f=e=null;y=t=0;var G=ja[b],H=ka[b];for(v=
0;v<n;v++){C=D=E=p=l=m=0;M=F*(I=u[t]);N=F*(J=u[t+1]);O=F*(K=u[t+2]);p+=z*I;l+=z*J;m+=z*K;f=B;for(e=0;e<F;e++)f.r=I,f.g=J,f.b=K,f=f.next;for(e=1;e<F;e++)k=t+((A<e?A:e)<<2),p+=(f.r=I=u[k])*(x=F-e),l+=(f.g=J=u[k+1])*x,m+=(f.b=K=u[k+2])*x,C+=I,D+=J,E+=K,f=f.next;e=B;f=Q;for(h=0;h<g;h++)u[t]=p*G>>H,u[t+1]=l*G>>H,u[t+2]=m*G>>H,p-=M,l-=N,m-=O,M-=e.r,N-=e.g,O-=e.b,k=y+((k=h+b+1)<A?k:A)<<2,C+=e.r=u[k],D+=e.g=u[k+1],E+=e.b=u[k+2],p+=C,l+=D,m+=E,e=e.next,M+=I=f.r,N+=J=f.g,O+=K=f.b,C-=I,D-=J,E-=K,f=f.next,t+=
4;y+=g}for(h=0;h<g;h++){D=E=C=l=m=p=0;t=h<<2;M=F*(I=u[t]);N=F*(J=u[t+1]);O=F*(K=u[t+2]);p+=z*I;l+=z*J;m+=z*K;f=B;for(e=0;e<F;e++)f.r=I,f.g=J,f.b=K,f=f.next;k=g;for(e=1;e<=b;e++)t=k+h<<2,p+=(f.r=I=u[t])*(x=F-e),l+=(f.g=J=u[t+1])*x,m+=(f.b=K=u[t+2])*x,C+=I,D+=J,E+=K,f=f.next,e<L&&(k+=g);t=h;e=B;f=Q;for(v=0;v<n;v++)k=t<<2,u[k]=p*G>>H,u[k+1]=l*G>>H,u[k+2]=m*G>>H,p-=M,l-=N,m-=O,M-=e.r,N-=e.g,O-=e.b,k=h+((k=v+F)<L?k:L)*g<<2,p+=C+=e.r=u[k],l+=D+=e.g=u[k+1],m+=E+=e.b=u[k+2],e=e.next,M+=I=f.r,N+=J=f.g,O+=
K=f.b,C-=I,D-=J,E-=K,f=f.next,t+=g}c.putImageData(q,0,0);c=!0}}c||d.ctx.drawImage(a.get(0),0,0);return!0}return cont}function da(){this.a=this.b=this.g=this.r=0;this.next=null}for(var y=jQuery,ea=y(this),la=y(".ws_list",H),Y=g.maxQuality||!0,fa=g.maxPreload||20,U=!g.noCanvas&&document.createElement("canvas").getContext,W=q.length,n=[],v=y("<div>").addClass("ws_effect ws_collage").css({position:"absolute",width:"100%",height:"100%",left:0,top:0,overflow:"hidden","z-index":8}).appendTo(H),z=0,ba=0,
L=g.width/(Math.sqrt(W)+1),X=g.height/(Math.sqrt(W)+1),G=Math.floor(g.width/L),d=0;d<W;d++)L+z>L*G&&(ba=Math.floor(L*(d+1)/g.width)*X,z=0),n[d]={x:z,y:ba,width:L,height:X,img:null},U&&(n[d].scale=w(.3,.7,Math.random()),n[d].angle=w(-180,180,Math.random())),z+=parseFloat(L);for(var ca,ga,d=n.length;d;ca=parseInt(Math.random()*d),ga=n[--d],n[d]=n[ca],n[ca]=ga);if(U){var h=y("<canvas>")[0];h.ctx=h.getContext("2d");h.width=v.width();h.height=v.height();var c=y("<canvas>")[0];c.ctx=c.getContext("2d");
c.width=v.width();c.height=v.height();var A=y("<canvas>")[0];A.ctx=A.getContext("2d");A.width=v.width();A.height=v.height();if(!Y){var B=y("<canvas>")[0];B.ctx=B.getContext("2d");B.width=v.width();B.height=v.height()}v.append(h)}else{h=v.clone().removeClass("ws_effect").css({overflow:"visible"});v.css("display","none").append(h);for(d in n)n[d].img=q[d].src,x(h,n[d],1);z="undefined"==W%G?0:W%G;startRight=0;bottomAddCount=2*G-z;rightAddCount=Math.ceil(W/G)+1;for(d=0;d<bottomAddCount;d++)x(h,{img:q[d%
q.length].src,width:L,height:X,x:(z+d)%G*L,y:ba+Math.floor((z+d)/G)*X},1);for(d=0;d<bottomAddCount;d++)x(h,{img:q[d%q.length].src,width:L,height:X,x:L*G,y:d*X},1)}var Z,aa;this.go=function(a,b){if(Z)return-1;g.images&&(n[a].img=q[a]);if(window.XMLHttpRequest){if(U){var c=g.width,d=g.height,h=1;Q(b,b,!1);Q(a,a,!1);Y?Q(2,fa+1,!1):(B.width=c,B.height=d,Q(2,fa+1,!0,B.ctx,[b,a]));aa||(rand=Math.round(w(0,W-1,Math.random())),A.width=v.width(),A.height=v.height(),aa=ia(y(q[rand]),10,A))}else c=H.width(),
d=H.height(),h=c/g.width;Z=new ha(a,b,h,c,d,function(){ea.trigger("effectEnd");v.hide();Z=0;if(!Y&&U)for(h in n)n[h].img=null})}else Z=0,la.stop(!0).animate({left:a?-a+"00%":/Safari/.test(navigator.userAgent)?"0%":0},g.duration,"easeInOutExpo",function(){ea.trigger("effectEnd")})};var ja=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,
360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,
259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],ka=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,
21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,
24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24]}jQuery.extend(jQuery.easing,{easeInOutQuad:function(g,q,H,w,x){return 1>(q/=x/2)?w/2*q*q+H:-w/2*(--q*(q-2)-1)+H}});
